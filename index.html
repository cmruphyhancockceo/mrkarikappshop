<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Email Sorter (MX Lookup)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h2 { color: #2c3e50; }
    .btn {
      display: inline-block; padding: 10px 20px; margin: 10px 5px 0 0;
      background: #3498db; color: white; text-decoration: none; border-radius: 5px;
    }
    .btn:hover { background: #2980b9; }
    input[type=file], input[type=submit] {
      margin: 10px 0; padding: 10px;
    }
    input[type=submit] {
      background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer;
    }
    input[type=submit]:hover { background: #219150; }
  </style>
</head>
<body>
  <h2>Email Sorter (MX Lookup)</h2>
  <form id="uploadForm">
    <input type="file" id="fileInput" accept=".txt">
    <input type="submit" value="Upload & Sort">
  </form>
  <div id="results"></div>

  <script>
    const EMAIL_REGEX = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    const DISPOSABLE = ["mailinator.com","10minutemail.com","tempmail.com","yopmail.com","trashmail.com"];

    async function getMX(domain) {
      try {
        const url = `https://cloudflare-dns.com/dns-query?name=${domain}&type=MX`;
        const res = await fetch(url, { headers: { "accept": "application/dns-json" }});
        const data = await res.json();
        if (!data.Answer) return "invalid";
        const answers = data.Answer.map(a => a.data.toLowerCase());
        if (answers.some(mx => mx.includes("google.com"))) return "google";
        if (answers.some(mx => mx.includes("outlook.com") || mx.includes("microsoft.com") || mx.includes("office365.com"))) return "microsoft";
        return "custom";
      } catch (e) {
        return "invalid";
      }
    }

    function downloadFile(filename, content) {
      const blob = new Blob([content], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = document.getElementById("fileInput").files[0];
      if (!file) { alert("Please select a file"); return; }

      const text = await file.text();
      const emails = text.split(/\r?\n/).map(e => e.trim().toLowerCase()).filter(Boolean);

      const workoffice = new Set();
      const mainproject = new Set();
      const bad = new Set();

      const domainCache = {};

      for (const email of emails) {
        if (!EMAIL_REGEX.test(email)) { bad.add(email); continue; }
        const domain = email.split("@")[1];
        if (DISPOSABLE.includes(domain)) { bad.add(email); continue; }

        if (!domainCache[domain]) {
          domainCache[domain] = await getMX(domain);
        }
        const provider = domainCache[domain];

        if (provider === "google" || provider === "microsoft") {
          workoffice.add(email);
        } else if (provider === "custom") {
          mainproject.add(email);
        } else {
          bad.add(email);
        }
      }

      document.getElementById("results").innerHTML = `
        <h3>Sorting Complete ✅</h3>
        <p><b>WorkOffice Emails:</b> ${workoffice.size}</p>
        <p><b>Main Project Emails:</b> ${mainproject.size}</p>
        <p><b>Bad Emails:</b> ${bad.size}</p>
        <button class="btn" onclick="downloadFile('WorkOffice_Emails.txt', '${[...workoffice].join("\\n")}')">⬇ WorkOffice Emails</button>
        <button class="btn" onclick="downloadFile('Main_Project_Emails.txt', '${[...mainproject].join("\\n")}')">⬇ Main Project Emails</button>
        <button class="btn" onclick="downloadFile('Bad_Emails.txt', '${[...bad].join("\\n")}')">⬇ Bad Emails</button>
      `;
    });
  </script>
</body>
</html>
